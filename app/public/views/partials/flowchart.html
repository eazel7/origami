<svg
  class="draggable-container"
  xmlns="http://www.w3.org/2000/svg"
  ng-mousedown="mouseDown($event)"
  ng-mousemove="mouseMove($event)"
  ng-style="{width: sizeAttributes(chart.data.sheetSize).width * chart.data.totalPages.x, height: sizeAttributes(chart.data.sheetSize).height * chart.data.totalPages.y}"
  >
  <defs>
    <marker
       orient="auto"
       refY="0.0"
       refX="0.0"
       id="ConnectorEnd"
       style="overflow:visible;fill: #333">
      <path
         style="fill-rule:evenodd;stroke-width:0.62500000;stroke-linejoin:round;"
         d="M 8.7185878,4.0337352 L -2.2072895,0.016013256 L 8.7185884,-4.0017078 C 6.9730900,-1.6296469 6.9831476,1.6157441 8.7185878,4.0337352 z "
         transform="scale(0.4) rotate(180) translate(1,0)" />
    </marker>
    <linearGradient
      spreadMethod="pad"
      y2="0"
      x2="0"
      y1="1"
      x1="0"
      id="nodeBackgroundGradient"
      >
      <stop
        offset="0"
        stop-opacity="0.99609"
        stop-color="#56aaff"
        />
        <stop
        offset="0.63934"
        stop-opacity="0.99219"
        stop-color="#d0d0e5"
        />
    </linearGradient>
    <linearGradient
      spreadMethod="pad"
      y2="0"
      x2="0"
      y1="1"
      x1="0"
      id="nodeDisabledBackgroundGradient"
      >
      <stop
        offset="0"
        stop-opacity="0.99609"
        stop-color="#454545"
        />
        <stop
        offset="0.63934"
        stop-opacity="0.99219"
        stop-color="#5E5E5E"
        />
    </linearGradient>
  </defs>

  <g>
    <rect
      ng-repeat="p in chart.data.pages"
      style="fill:#ffffff;stroke-width:1;stroke-miterlimit:4;stroke-dasharray:3,1;fill-opacity:1;stroke:#000000;stroke-opacity:1;stroke-dashoffset:0"
      ng-attr-width="{{sizeAttributes(chart.data.sheetSize).width}}"
      ng-attr-height="{{sizeAttributes(chart.data.sheetSize).height}}"
      ng-attr-x="{{(p.x - 1) * sizeAttributes(chart.data.sheetSize).width}}"
      ng-attr-y="{{(p.y - 1) * sizeAttributes(chart.data.sheetSize).height}}"/>
  </g>

  <g>
    <g ng-repeat="cs in chart.data.customShapes" 
      ng-html-compile="templateForCustomShape(cs)">
    </g>
  </g>
  
  <g
    ng-repeat="node in chart.nodes"
    ng-mousedown="nodeMouseDown($event, node)"
    ng-attr-transform="translate({{node.x()}}, {{node.y()}})"
    >
    <rect
      ng-attr-class="{{node.selected() && 'selected-node-rect' || (node == mouseOverNode && 'mouseover-node-rect' || node.disabled() && 'disabled-node-rect' || 'node-rect')}}"
      ry="10"
      rx="10"
      x="0"
      y="0"
      ng-attr-width="{{node.width()}}"
      ng-attr-height="{{node.height()}}"
      ng-attr-fill="url(#{{(node.disabled() && 'nodeDisabledBackgroundGradient') ||'nodeBackgroundGradient'}})"
      >

    </rect>

    <text
      ng-attr-x="{{node.width()/2}}"
      y="20"
      text-anchor="middle"
      style="font-weight: 700"
      alignment-baseline="middle"
      >
      {{node.data.label || node.name()}}
    </text>

    <g
      ng-repeat="connector in node.inputConnectors|filter:{'data':{'use':'runtime'}}"
      ng-mousedown="connectorMouseDown($event, node, connector, $index, true)"
      class="connector input-connector"
      >
      <text
        ng-attr-x="{{connector.x() + 20}}"
        ng-attr-y="{{connector.y()}}"
        text-anchor="left"
        alignment-baseline="middle"
        >
        {{connector.name()}}
      </text>

      <circle
        ng-attr-class="{{connector == mouseOverConnector && 'mouseover-connector-circle' || 'connector-circle'}}"
        ng-attr-r="{{connectorSize}}"
        ng-attr-cx="{{connector.x()}}"
        ng-attr-cy="{{connector.y()}}"
        />
    </g>

    <g
      ng-repeat="connector in node.outputConnectors"
      ng-mousedown="connectorMouseDown($event, node, connector, $index, false)"
      class="connector output-connector"
      >
      <text
        ng-attr-x="{{connector.x() - 20}}"
        ng-attr-y="{{connector.y()}}"
        text-anchor="end"
        alignment-baseline="middle"
        >
        {{connector.name()}}
      </text>

      <circle
        ng-attr-class="{{connector == mouseOverConnector && 'mouseover-connector-circle' || 'connector-circle'}}"
        ng-attr-r="{{connectorSize}}"
        ng-attr-cx="{{connector.x()}}"
        ng-attr-cy="{{connector.y()}}"
        />
    </g>
  </g>

  <g>
    <g
      ng-repeat="connection in chart.connections"
      class="connection"
      ng-mousedown="connectionMouseDown($event, connection)"
      >
        <path
          ng-attr-class="{{(connection.selected() && 'selected-connection-line' || (connection == mouseOverConnection && 'mouseover-connection-line' || 'connection-line')+(($parent.$parent.isActiveConnection(connection.data.metadata.id) && ' connected') || ''))}}"
          style="marker-end:url(#ConnectorEnd)"
          ng-attr-d="M {{connection.sourceCoordX()}}, {{connection.sourceCoordY()}}
                     C {{connection.sourceTangentX()}}, {{connection.sourceTangentY()}}
                       {{connection.destTangentX()}}, {{connection.destTangentY()}}
                       {{connection.destCoordX()}}, {{connection.destCoordY()}}"
          >
              <animate ng-if="$parent.$parent.isActiveConnection(connection.data.metadata.id)" attributeName="stroke-dashoffset" from="1000" to="0"
        repeatCount="indefinite" dur="10s" />

          
        </path>
        <circle
            ng-attr-class="{{connection.selected() && 'selected-connection-endpoint' || (connection == mouseOverConnection && 'mouseover-connection-endpoint' || 'connection-endpoint')}}"
            r="5"
            ng-attr-cx="{{connection.sourceCoordX()}}"
            ng-attr-cy="{{connection.sourceCoordY()}}"
            >
        </circle>

        <circle
            ng-attr-class="{{connection.selected() && 'selected-connection-endpoint' || (connection == mouseOverConnection && 'mouseover-connection-endpoint' || 'connection-endpoint')}}"
            r="5"
            ng-attr-cx="{{connection.destCoordX()}}"
            ng-attr-cy="{{connection.destCoordY()}}"
            >
        </circle>
    </g>
  </g>

  <g
    ng-if="draggingConnection"
    >
    <path
      class="dragging-connection dragging-connection-line"
      ng-attr-d="M {{dragPoint1.x}}, {{dragPoint1.y}}
                 C {{dragTangent1.x}}, {{dragTangent1.y}}
                   {{dragTangent2.x}}, {{dragTangent2.y}}
                   {{dragPoint2.x}}, {{dragPoint2.y}}"
      >
    </path>

    <circle
        class="dragging-connection dragging-connection-endpoint"
        r="4"
        ng-attr-cx="{{dragPoint1.x}}"
        ng-attr-cy="{{dragPoint1.y}}"
        >
    </circle>

    <circle
        class="dragging-connection dragging-connection-endpoint"
        r="4"
        ng-attr-cx="{{dragPoint2.x}}"
        ng-attr-cy="{{dragPoint2.y}}"
        >
    </circle>
  </g>

  <rect
      ng-if="dragSelecting"
      class="drag-selection-rect"
      ng-attr-x="{{dragSelectionRect.x}}"
      ng-attr-y="{{dragSelectionRect.y}}"
      ng-attr-width="{{dragSelectionRect.width}}"
      ng-attr-height="{{dragSelectionRect.height}}"
    >
  </rect>

</svg>
